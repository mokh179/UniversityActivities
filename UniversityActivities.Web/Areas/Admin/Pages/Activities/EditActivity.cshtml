@page "{id:int}"
@model UniversityActivities.Web.Areas.Admin.Pages.Activities.EditActivityModel
@{
    ViewData["Title"] = "Edit Activity";
}
<style>
    <style >
    /* ===== Layout ===== */
    .management-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    /* ===== Dropdown ===== */
    .chip-select {
        position: relative;
    }

    .chip-input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #d1d5db;
    }

    .chip-dropdown {
        position: absolute;
        width: 100%;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        margin-top: 6px;
        max-height: 260px;
        overflow-y: auto;
        z-index: 100;
    }

    /* ===== Dropdown Item ===== */
    .chip-item {
        padding: 10px 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
    }

        .chip-item:hover {
            background: #f3f4f6;
        }

    .item-badge {
        font-size: 12px;
        background: #eef2ff;
        color: #3730a3;
        padding: 4px 8px;
        border-radius: 14px;
    }

    /* ===== Selected Panel ===== */
    .selected-panel {
        border: 1px dashed #d1d5db;
        border-radius: 10px;
        padding: 12px;
        min-height: 180px;
        background: #fafafa;
    }

    /* ===== Chips ===== */
    .chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        background: #16a34a;
        color: #fff;
        font-size: 13px;
        margin: 4px;
    }

    .chip-remove {
        cursor: pointer;
        font-weight: bold;
    }
    /* ===== LEFT LISTS (DROPDOWNS) ===== */
    .chip-select {
        position: relative;
        margin-bottom: 16px;
    }

    .chip-dropdown {
        position: relative; /* ❌ مش absolute */
        margin-top: 6px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background: #fff;
        max-height: 220px;
        overflow-y: auto;
    }

    /* كل عنصر في الليست */
    .chip-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 12px;
        border-bottom: 1px solid #f1f1f1;
        cursor: pointer;
    }

        .chip-item:last-child {
            border-bottom: none;
        }

        .chip-item:hover {
            background: #f8fafc;
        }

    /* Badge الدور */
    .item-badge {
        background: #eef2ff;
        color: #4338ca;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
    }

    /* ===== RIGHT PANEL (CHIPS) ===== */
    #selectedChipsPanel {
        min-height: 180px;
        border: 1px dashed #e5e7eb;
        border-radius: 10px;
        padding: 14px;
    }

    /* CHIP */
    .chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #16a34a;
        color: #fff;
        padding: 6px 12px;
        border-radius: 999px;
        margin: 6px 6px 0 0;
        font-size: 13px;
    }

    .chip-remove {
        cursor: pointer;
        font-weight: bold;
    }

</style>
<!-- ================= HEADER ================= -->
<div class="card mb-4 border-0">
    <div class="card-body p-0">
        <div class="bg-warning rounded-3 text-dark p-4 d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-1 fw-bold">Edit Activity</h5>
                <p class="mb-0 small opacity-75">Update activity details</p>
            </div>
            <a asp-page="./Index" class="btn btn-outline-dark">Back</a>
        </div>
    </div>
</div>

<form method="post" enctype="multipart/form-data">

    <!-- ================= IMAGE ================= -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <h6 class="fw-semibold mb-3">Activity Image</h6>

            @if (!string.IsNullOrEmpty(Model.Input.ImageUrl))
            {
                <img src="@Model.Input.ImageUrl"
                     class="img-thumbnail mb-3"
                     style="max-height:200px"
                     id="imagePreview" />
            }

            <input type="file"
                   class="form-control"
                   id="activityImage"
                   name="Image" />
        </div>
    </div>

    <!-- ================= BASIC INFO ================= -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <h6 class="fw-semibold mb-3">Basic Information</h6>

            <div class="row g-3">

                <div class="col-md-6">
                    <label asp-for="Input.TitleEn"></label>
                    <input asp-for="Input.TitleEn" class="form-control" />
                </div>

                <div class="col-md-6">
                    <label asp-for="Input.TitleAr"></label>
                    <input asp-for="Input.TitleAr" class="form-control" />
                </div>

                <div class="col-md-6">
                    <label>Management Type</label>
                    <select asp-for="Input.ManagementTypeId"
                            id="managementTypeSelect"
                            class="form-select">
                        <option value="">Select</option>
                        @foreach (var t in Model.Lookups.ManagementTypes)
                        {
                            <option value="@t.Id">@t.NameEn</option>
                        }
                    </select>
                </div>

                <div class="col-md-6">
                    <label>Management</label>
                    <select asp-for="Input.ManagementId"
                            id="managementSelect"
                            class="form-select">
                        <option value="">Select</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label>Club</label>
                    <select asp-for="Input.ClubId"
                            id="clubSelect"
                            class="form-select">
                        <option value="">Select</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label asp-for="Input.ActivityTypeId"></label>
                    <select asp-for="Input.ActivityTypeId"
                            class="form-select">
                        <option value="">Select</option>
                        @foreach (var t in Model.Lookups.ActivityTypes)
                        {
                            <option value="@t.Id">@t.NameEn</option>
                        }
                    </select>
                </div>

                <div class="col-md-6">
                    <label asp-for="Input.StartDate"></label>
                    <input asp-for="Input.StartDate"
                           type="datetime-local"
                           class="form-control" />
                </div>

                <div class="col-md-6">
                    <label asp-for="Input.EndDate"></label>
                    <input asp-for="Input.EndDate"
                           type="datetime-local"
                           class="form-control" />
                </div>

            </div>
        </div>
    </div>

    <!-- ================= DESCRIPTIONS ================= -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <h6 class="fw-semibold mb-3">Descriptions</h6>

            <div class="row g-3">
                <div class="col-md-6">
                    <label asp-for="Input.DescriptionEn"></label>
                    <textarea asp-for="Input.DescriptionEn"
                              class="form-control" rows="4"></textarea>
                </div>
                <div class="col-md-6">
                    <label asp-for="Input.DescriptionAr"></label>
                    <textarea asp-for="Input.DescriptionAr"
                              class="form-control" rows="4"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= ASSIGNMENTS ================= -->
    <div class="row g-4">

        <!-- LEFT -->
        <div class="col-md-6">

            <div class="mb-3" id="dropdown1Wrapper">
                <label class="form-label fw-semibold">Coordinators</label>
                <div class="chip-select" data-role-id="1" data-role-name="Coordinator">
                    <input class="form-control chip-input" placeholder="Search user..." />
                    <div class="chip-dropdown"></div>
                </div>
            </div>

            <div class="mb-3" id="dropdown2Wrapper">
                <label class="form-label fw-semibold">Supervisors</label>
                <div class="chip-select" data-role-id="2" data-role-name="Supervisor">
                    <input class="form-control chip-input" placeholder="Search user..." />
                    <div class="chip-dropdown"></div>
                </div>
            </div>

            <div class="mb-3" id="dropdown3Wrapper">
                <label class="form-label fw-semibold">Viewers</label>
                <div class="chip-select" data-role-id="3" data-role-name="Viewer">
                    <input class="form-control chip-input" placeholder="Search user..." />
                    <div class="chip-dropdown"></div>
                </div>
            </div>

        </div>

        <!-- RIGHT -->
        <div class="col-md-6">
            <label class="form-label fw-semibold">Selected Assignments</label>
            <div id="selectedChipsPanel" class="selected-panel">
                <div class="text-muted small">No assignments selected</div>
            </div>
        </div>

    </div>

    <!-- ================= PUBLISH ================= -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body d-flex justify-content-between align-items-center">
            <div class="form-check">
                <input asp-for="Input.IsPublished"
                       class="form-check-input" />
                <label asp-for="Input.IsPublished"
                       class="form-check-label fw-semibold"></label>
            </div>

            <button type="submit"
                    class="btn btn-warning px-4">
                Update Activity
            </button>
        </div>
    </div>

</form>

<script>
    console.log("JS LOADED");

    /* ===================== EDIT DATA ===================== */
    window.editData = {
        managementTypeId: @Model.Input.ManagementTypeId,
        managementId: @Model.Input.ManagementId,
        clubId: @(Model.Input.ClubId ?? 0),
        assignments: @Html.Raw(
                        System.Text.Json.JsonSerializer.Serialize(
                                Model.Input.Assignments 
                        )
                )
    };

    /* ===================== STATE ===================== */
    let usersCache = [];

    let assignment = {
        coordinators: [],
        supervisors: [],
        viewers: []
    };

    /* ===================== HELPERS ===================== */
    function getUserName(u) {
        console.log(u)
    const user = usersCache.find(u => u.id === userId);
      return user
          ? (user.fullname || user.name || user.nameEn || user.userName)
          : `User #${userId}`;
    }

    function getAllSelectedIds() {
        return [
            ...assignment.coordinators,
            ...assignment.supervisors,
            ...assignment.viewers
        ].map(x => x.userId);
    }

    /* ===================== LOADERS ===================== */
    async function loadManagements(typeId) {
        const res = await fetch(`?handler=ManagementsByType&managementTypeId=${typeId}`);
        const data = await res.json();

        const select = document.getElementById("managementSelect");
        select.innerHTML = `<option value="">Select</option>`;
        data.forEach(m => {
            select.innerHTML += `<option value="${m.id}">${m.nameEn}</option>`;
        });
    }

    async function loadClubs(managementId) {
        const res = await fetch(`?handler=ClubsByManagement&managementId=${managementId}`);
        const data = await res.json();

        const select = document.getElementById("clubSelect");
        select.innerHTML = `<option value="">Select</option>`;
        data.forEach(c => {
            select.innerHTML += `<option value="${c.id}">${c.nameEn}</option>`;
        });
    }

    async function loadUsers(managementId) {
        const res = await fetch(`?handler=UsersByManagement&managementId=${managementId}`);
        usersCache = await res.json();
            renderAll();

    }

    /* ===================== DROPDOWNS ===================== */
    // function renderDropdown(wrapperId, roleId, roleName) {

    //     const wrapper = document.getElementById(wrapperId);
    //     const input = wrapper.querySelector(".chip-input");
    //     const dropdown = wrapper.querySelector(".chip-dropdown");

    //     const q = input.value.toLowerCase();
    //     const usedIds = getAllSelectedIds();

    //     dropdown.innerHTML = "";

    //     usersCache.forEach(u => {

    //         if (usedIds.includes(u.id)) return;

    //         const name = getUserName(u);
    //         if (q && !name.toLowerCase().includes(q)) return;

    //         const div = document.createElement("div");
    //         div.className = "chip-item";
    //         div.innerHTML = `
    //             <span>${name}</span>
    //             <span class="item-badge">${roleName}</span>
    //         `;

    //         div.onclick = () => {
    //             addAssignment(u.id, name, roleId);
    //             input.value = "";
    //             renderAll();
    //         };

    //         dropdown.appendChild(div);
    //     });
    // }
        /* ===== RENDER DROPDOWNS ===== */
    function renderDropdowns() {

        document.querySelectorAll(".chip-select").forEach(select => {

            const dropdown = select.querySelector(".chip-dropdown");
            const input = select.querySelector(".chip-input");
            const roleId = +select.dataset.roleId;
            const roleName = select.dataset.roleName;
            const q = input.value.toLowerCase();

            dropdown.innerHTML = "";

            const usedIds = [
                ...assignment.coordinators,
                ...assignment.supervisors,
                ...assignment.viewers
            ].map(x => x.userId);

            usersCache.forEach(user => {

                if (usedIds.includes(user.id)) return;

                const name = getUserName(user.id);
                if (q && !name.toLowerCase().includes(q)) return;

                const div = document.createElement("div");
                div.className = "chip-item";
                div.innerHTML = `
                    <span>${name}</span>
                    <span class="item-badge">${roleName}</span>
                `;

                div.onclick = () => {
                    addAssignment(user.id, roleId);
                    input.value = "";
                };

                dropdown.appendChild(div);
            });
        });
    }

    /* ===================== ASSIGNMENTS ===================== */
        /* ===== ADD / REMOVE ===== */
    function addAssignment(userId, roleId) {

        const target =
            roleId === 1 ? assignment.coordinators :
            roleId === 2 ? assignment.supervisors :
            assignment.viewers;

        if (target.some(x => x.userId === userId)) return;

        target.push({ userId, roleId });
        renderAll();
    }

    function removeAssignment(userId, roleId) {

        if (roleId === 1)
            assignment.coordinators =
                assignment.coordinators.filter(x => x.userId !== userId);

        if (roleId === 2)
            assignment.supervisors =
                assignment.supervisors.filter(x => x.userId !== userId);

        if (roleId === 3)
            assignment.viewers =
                assignment.viewers.filter(x => x.userId !== userId);

        renderAll();
    }


    /* ===================== CHIPS ===================== */
    /* ===== RENDER CHIPS ===== */
    function renderChips() {

        const panel = document.getElementById("selectedChipsPanel");
        panel.innerHTML = "";

        const draw = (title, list, roleId) => {

            if (!list.length) return;

            panel.insertAdjacentHTML(
                "beforeend",
                `<h6 class="mb-2">${title}</h6>`
            );

            list.forEach(item => {

                const name = getUserName(item.userId);

                const chip = document.createElement("div");
                chip.className = "chip";
                chip.innerHTML = `
                    ${name}
                    <span class="chip-remove">&times;</span>
                `;

                chip.querySelector(".chip-remove").onclick =
                    () => removeAssignment(item.userId, roleId);

                panel.appendChild(chip);
            });
        };

        draw("Coordinators", assignment.coordinators, 1);
        draw("Supervisors", assignment.supervisors, 2);
        draw("Viewers", assignment.viewers, 3);
    }

    /* ===================== RENDER ALL ===================== */
    function renderAll() {
       renderDropdowns();
    renderChips();
    }

    /* ===================== INIT EDIT PAGE ===================== */
    document.addEventListener("DOMContentLoaded", async () => {

        console.log("BOOTSTRAP EDIT");

        // load managements
        await loadManagements(editData.managementTypeId);
        document.getElementById("managementSelect").value = editData.managementId;

        // load clubs
        await loadClubs(editData.managementId);
        if (editData.clubId)
            document.getElementById("clubSelect").value = editData.clubId;

        // load users
        await loadUsers(editData.managementId);

        // load existing assignments
        editData.assignments.forEach(a => {
               const user = usersCache.find(u => u.id === a.userId);
               const name = user? getUserName(user): `User #${a.userId}`; // fallback حقيقي
                  addAssignment(a.userId, name, a.activityRoleId);
            });

        // wire inputs
        document.querySelectorAll(".chip-input").forEach(() => {
            document.querySelectorAll(".chip-input").forEach(inp => {
                inp.addEventListener("input", renderAll);
            });
        });

        renderAll();
    });
</script>




